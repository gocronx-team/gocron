name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: web/vue/yarn.lock

    - name: Build frontend
      run: make build-vue

    - name: Upload frontend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: web/public/

  build-gocron-node:
    needs: build-frontend
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
          - os: ubuntu-latest
            goos: windows
            goarch: arm64
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Build gocron-node (Unix)
      if: runner.os != 'Windows'
      run: |
        chmod +x package.sh
        bash ./package.sh -p "${{ matrix.goos }}" -a "${{ matrix.goarch }}"

    - name: Install zip (Windows)
      if: runner.os == 'Windows'
      run: choco install zip -y

    - name: Build gocron-node (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: bash ./package.sh -p "${{ matrix.goos }}" -a "${{ matrix.goarch }}"

    - name: Upload gocron-node artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gocron-node-${{ matrix.goos }}-${{ matrix.goarch }}
        path: gocron-node-package/*

  build:
    needs: [build-frontend, build-gocron-node]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
          - os: ubuntu-latest
            goos: windows
            goarch: arm64
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Download frontend artifacts
      uses: actions/download-artifact@v4
      continue-on-error: false
      with:
        name: frontend-dist
        path: web/public/

    - name: Download all gocron-node artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: gocron-node-*
        path: gocron-node-package/
        merge-multiple: true

    - name: Generate static assets
      run: |
        go install github.com/rakyll/statik@latest
        go generate ./...

    - name: Build gocron only (Unix)
      if: runner.os != 'Windows'
      run: |
        chmod +x package.sh
        # åªæž„å»º gocronï¼Œä¸æž„å»º gocron-nodeï¼ˆå·²ç»ä¸‹è½½ï¼‰
        VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
        BINARY_NAME='gocron'
        MAIN_FILE="./cmd/gocron/gocron.go"
        GIT_COMMIT_ID=$(git rev-parse --short HEAD)
        LDFLAGS="-w -X 'main.AppVersion=${VERSION}' -X 'main.BuildDate=$(date '+%Y-%m-%d %H:%M:%S')' -X 'main.GitCommit=${GIT_COMMIT_ID}'"
        mkdir -p gocron-build/gocron-${{ matrix.goos }}-${{ matrix.goarch }}
        env CGO_ENABLED=1 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "${LDFLAGS}" -o gocron-build/gocron-${{ matrix.goos }}-${{ matrix.goarch }}/gocron ./cmd/gocron/gocron.go
        # å°†æ‰€æœ‰ gocron-node åŒ…å¤åˆ¶åˆ° gocron æž„å»ºç›®å½•
        cp -r gocron-node-package gocron-build/gocron-${{ matrix.goos }}-${{ matrix.goarch }}/
        mkdir -p gocron-package
        cd gocron-build
        tar czf ../gocron-package/gocron-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz gocron-${{ matrix.goos }}-${{ matrix.goarch }}

    - name: Build gocron only (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
        BINARY_NAME='gocron'
        MAIN_FILE="./cmd/gocron/gocron.go"
        GIT_COMMIT_ID=$(git rev-parse --short HEAD)
        LDFLAGS="-w -X 'main.AppVersion=${VERSION}' -X 'main.BuildDate=$(date '+%Y-%m-%d %H:%M:%S')' -X 'main.GitCommit=${GIT_COMMIT_ID}'"
        mkdir -p gocron-build/gocron-${{ matrix.goos }}-${{ matrix.goarch }}
        env CGO_ENABLED=1 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "${LDFLAGS}" -o gocron-build/gocron-${{ matrix.goos }}-${{ matrix.goarch }}/gocron.exe ./cmd/gocron/gocron.go
        # å°†æ‰€æœ‰ gocron-node åŒ…å¤åˆ¶åˆ° gocron æž„å»ºç›®å½•
        cp -r gocron-node-package gocron-build/gocron-${{ matrix.goos }}-${{ matrix.goarch }}/
        mkdir -p gocron-package
        cd gocron-build
        zip -rq ../gocron-package/gocron-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.zip gocron-${{ matrix.goos }}-${{ matrix.goarch }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.goos }}-${{ matrix.goarch }}
        path: |
          gocron-package/*
          gocron-node-package/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: packages-*
        merge-multiple: true

    - name: Generate release notes
      id: release_notes
      run: |
        # èŽ·å–å½“å‰tagå’Œä¸Šä¸€ä¸ªtag
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        echo "## ðŸš€ What's New in $CURRENT_TAG" > release_notes.md
        echo "" >> release_notes.md
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ðŸ“ Changes since $PREVIOUS_TAG:" >> release_notes.md
          echo "" >> release_notes.md
          
          # èŽ·å–æäº¤ä¿¡æ¯å¹¶åˆ†ç±»
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- feat" | sed 's/^- feat/âœ¨ **Feature**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- fix" | sed 's/^- fix/ðŸ› **Fix**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- docs" | sed 's/^- docs/ðŸ“š **Docs**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- refactor" | sed 's/^- refactor/â™»ï¸ **Refactor**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- perf" | sed 's/^- perf/âš¡ **Performance**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -vE "^- (feat|fix|docs|refactor|perf)" | sed 's/^- /ðŸ”§ **Other**: /' >> release_notes.md || true
        else
          echo "ðŸŽ‰ Initial release of gocron - A lightweight cron task management system" >> release_notes.md
        fi
        


    - name: List downloaded files
      run: |
        echo "=== gocron packages ==="
        ls -lh gocron-package/ || echo "No gocron packages"
        echo "=== gocron-node packages ==="
        ls -lh gocron-node-package/ || echo "No gocron-node packages"

    - name: Create Release
      run: |
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PRERELEASE_FLAG=""
        if [[ "$CURRENT_TAG" == *"alpha"* ]] || [[ "$CURRENT_TAG" == *"beta"* ]] || [[ "$CURRENT_TAG" == *"rc"* ]]; then
          PRERELEASE_FLAG="--prerelease"
        fi
        
        gh release create "$CURRENT_TAG" \
          --title "Release $CURRENT_TAG" \
          --notes-file release_notes.md \
          $PRERELEASE_FLAG \
          gocron-package/*.tar.gz \
          gocron-package/*.zip \
          gocron-node-package/*.tar.gz \
          gocron-node-package/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}